/**
 * Sliding window conversation history management.
 *
 * This module provides a sliding window strategy for managing conversation history
 * that preserves tool usage pairs and avoids invalid window states.
 */
import type { HookProvider } from '../hooks/types.js';
import type { HookRegistry } from '../hooks/registry.js';
/**
 * Configuration for the sliding window conversation manager.
 */
export type SlidingWindowConversationManagerConfig = {
    /**
     * Maximum number of messages to keep in the conversation history.
     * Defaults to 40 messages.
     */
    windowSize?: number;
    /**
     * Whether to truncate tool results when a message is too large for the model's context window.
     * Defaults to true.
     */
    shouldTruncateResults?: boolean;
};
/**
 * Implements a sliding window strategy for managing conversation history.
 *
 * This class handles the logic of maintaining a conversation window that preserves
 * tool usage pairs and avoids invalid window states. When the message count exceeds
 * the window size, it will either truncate large tool results or remove the oldest
 * messages while ensuring tool use/result pairs remain valid.
 *
 * As a HookProvider, it registers callbacks for:
 * - AfterInvocationEvent: Applies sliding window management after each invocation
 * - AfterModelCallEvent: Reduces context on overflow errors and requests retry
 */
export declare class SlidingWindowConversationManager implements HookProvider {
    private readonly _windowSize;
    private readonly _shouldTruncateResults;
    /**
     * Initialize the sliding window conversation manager.
     *
     * @param config - Configuration options for the sliding window manager.
     */
    constructor(config?: SlidingWindowConversationManagerConfig);
    /**
     * Registers callbacks with the hook registry.
     *
     * Registers:
     * - AfterInvocationEvent callback to apply sliding window management
     * - AfterModelCallEvent callback to handle context overflow and request retry
     *
     * @param registry - The hook registry to register callbacks with
     */
    registerCallbacks(registry: HookRegistry): void;
    /**
     * Apply the sliding window to the messages array to maintain a manageable history size.
     *
     * This method is called after every event loop cycle to apply a sliding window if the message
     * count exceeds the window size. If the number of messages is within the window size, no action
     * is taken.
     *
     * @param messages - The message array to manage. Modified in-place.
     */
    private applyManagement;
    /**
     * Trim the oldest messages to reduce the conversation context size.
     *
     * The method handles special cases where trimming the messages leads to:
     * - toolResult with no corresponding toolUse
     * - toolUse with no corresponding toolResult
     *
     * The strategy is:
     * 1. First, attempt to truncate large tool results if shouldTruncateResults is true
     * 2. If truncation is not possible or doesn't help, trim oldest messages
     * 3. When trimming, skip invalid trim points (toolResult at start, or toolUse without following toolResult)
     *
     * @param messages - The message array to reduce. Modified in-place.
     * @param _error - The error that triggered the context reduction, if any.
     *
     * @throws ContextWindowOverflowError If the context cannot be reduced further,
     *         such as when the conversation is already minimal or when no valid trim point exists.
     */
    private reduceContext;
    /**
     * Truncate tool results in a message to reduce context size.
     *
     * When a message contains tool results that are too large for the model's context window,
     * this function replaces the content of those tool results with a simple error message.
     *
     * @param messages - The conversation message history.
     * @param msgIdx - Index of the message containing tool results to truncate.
     * @returns True if any changes were made to the message, false otherwise.
     */
    private truncateToolResults;
    /**
     * Find the index of the last message containing tool results.
     *
     * This is useful for identifying messages that might need to be truncated to reduce context size.
     *
     * @param messages - The conversation message history.
     * @returns Index of the last message with tool results, or undefined if no such message exists.
     */
    private findLastMessageWithToolResults;
}
//# sourceMappingURL=sliding-window-conversation-manager.d.ts.map